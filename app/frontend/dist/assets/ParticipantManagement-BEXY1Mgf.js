import{c as l,j as e}from"./ui-CmEgarRF.js";import{r as n}from"./vendor-Ce54acmE.js";import V from"./AdminLayout-Bdj-l822.js";import{i as h}from"./index-BjMOTf-D.js";import"./auth-B5F6nbqB.js";import"./utils-DH2Y5gFI.js";const ae=()=>{const[N,_]=n.useState([]),[P,y]=n.useState([]),[r,M]=n.useState(""),[R,C]=n.useState(!1),[f,K]=n.useState(""),[d,m]=n.useState(1),[u,w]=n.useState(1),[g,v]=n.useState(0),[x]=n.useState(20),[E,S]=n.useState(!1),[o,p]=n.useState({name:"",email:"",phone_number:"",nik:"",institution:""}),[L,b]=n.useState(!1),[j,$]=n.useState(null),I=n.useCallback(async()=>{try{const a=await h.get("/api/admin/events");Array.isArray(a.data)?y(a.data):y(a.data.events||[])}catch(a){console.error("Error fetching events:",a),l.error("Gagal memuat daftar event"),y([])}},[]),k=async()=>{if(r){C(!0);try{const a=await h.get(`/api/admin/events/${r}/participants`,{params:{page:d,per_page:x,search:f}});if(console.log("Participants API Response:",a.data),console.log("Participants count:",a.data.participants?.length||0),console.log("Pagination data:",a.data.pagination),_(a.data.participants||[]),a.data.pagination){const t=a.data.pagination.total_pages||a.data.pagination.totalPages||1,c=a.data.pagination.current_page||a.data.pagination.currentPage||1,s=a.data.pagination.total_count||a.data.pagination.totalCount||0;console.log("Setting pagination:",{totalPages:t,currentPage:c,totalCount:s}),w(t),m(c),v(s)}else{const t=a.data.participants?.length||0;console.log("No pagination info from backend. Participant count:",t),t>=x?(console.log("No pagination info but have full page - there might be more data"),w(Math.max(2,Math.ceil(t/x)+1)),v(t)):(w(1),v(t)),m(d)}}catch(a){console.error("Error fetching participants:",a),l.error("Gagal memuat daftar peserta")}finally{C(!1)}}};n.useEffect(()=>{I()},[I]),n.useEffect(()=>{r&&k()},[r,d,f,x]);const D=()=>{r&&m(1)},O=async()=>{try{const t=(await h.get(`/api/admin/events/${r}/participants`,{params:{page:1,per_page:1e4,search:""}})).data.participants||[];console.log(`✅ Successfully fetched ${t.length} participants for export`);const s=[["No Registrasi","Nama","Email","Telepon","NIK","Instansi","Tanggal Daftar"].join(",")];return t.forEach(i=>{const A=[`"${i.registrationNumber||""}"`,`"${i.name||""}"`,`"${i.email||""}"`,`"${i.phoneNumber||""}"`,`"${i.nik||""}"`,`"${i.institution||""}"`,`"${new Date(i.createdAt).toLocaleDateString("id-ID")}"`];s.push(A.join(","))}),s.join(`
`)}catch(a){console.error("Error fetching all participants for export:",a);const c=[["No Registrasi","Nama","Email","Telepon","NIK","Instansi","Tanggal Daftar"].join(",")];return N.forEach(s=>{const i=[`"${s.registrationNumber||""}"`,`"${s.name||""}"`,`"${s.email||""}"`,`"${s.phoneNumber||""}"`,`"${s.nik||""}"`,`"${s.institution||""}"`,`"${new Date(s.createdAt).toLocaleDateString("id-ID")}"`];c.push(i.join(","))}),c.join(`
`)}},F=async()=>{if(r){S(!0);try{console.log("Starting export process...");const a=await O();if(!a||a.trim()===""){l.error("Tidak ada data peserta untuk diekspor");return}const t=new Blob([a],{type:"text/csv;charset=utf-8;"});if(t.size===0){l.error("File CSV kosong - tidak ada data untuk diekspor");return}const c=window.URL.createObjectURL(t),s=document.createElement("a");s.href=c;const i=P.find(q=>q.id.toString()===r),U=`peserta-${i?i.name.replace(/[^a-zA-Z0-9]/g,"-"):r}-${new Date().toISOString().split("T")[0]}.csv`;s.setAttribute("download",U),document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(c);const X=a.split(`
`).length-1;l.success(`✅ Data ${X} peserta berhasil diunduh`)}catch(a){console.error("Error during export:",a),l.error("Gagal mengunduh data peserta - silakan coba lagi")}finally{S(!1)}}},z=async a=>{if(a.preventDefault(),!r){l.error("Pilih event terlebih dahulu");return}try{j?(await h.put(`/api/admin/events/${r}/participants/${j.id}`,{participant:o}),l.success("Data peserta berhasil diperbarui")):(await h.post(`/api/admin/events/${r}/participants`,{participant:o}),l.success("Peserta berhasil ditambahkan")),b(!1),T(),k()}catch(t){if(t&&typeof t=="object"&&"response"in t&&t.response&&typeof t.response=="object"&&"data"in t.response&&t.response.data&&typeof t.response.data=="object"&&"errors"in t.response.data){const c=Object.entries(t.response.data.errors).map(([s,i])=>`${s}: ${i}`).join(", ");l.error(`Error: ${c}`)}else l.error("Terjadi kesalahan saat menyimpan data peserta")}},B=a=>{$(a),p({name:a.name,email:a.email||"",phone_number:a.phoneNumber||"",nik:a.nik||"",institution:a.institution||""}),b(!0)},H=async a=>{if(r&&window.confirm("Apakah Anda yakin ingin menghapus peserta ini?"))try{await h.delete(`/api/admin/events/${r}/participants/${a}`),l.success("Peserta berhasil dihapus"),k()}catch{l.error("Gagal menghapus peserta")}},T=()=>{$(null),p({name:"",email:"",phone_number:"",nik:"",institution:""})},G=a=>!a||a.length<16?a:`${a.substring(0,8)}XXXX${a.substring(12)}`;return e.jsx(V,{children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Manajemen Peserta"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{T(),b(!0)},className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"Tambah Peserta"}),e.jsx("button",{onClick:F,disabled:!r||E,className:"bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:bg-gray-400 flex items-center gap-2",children:E?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{children:"Mengunduh..."})]}):"Export Excel"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2",children:"Pilih Event"}),e.jsxs("select",{value:r||"",onChange:a=>M(a.target.value),className:"w-full border p-2 rounded",children:[e.jsx("option",{value:"",children:"Pilih Event"}),P.map(a=>e.jsxs("option",{value:a.id,children:[a.name," (",a.participantsCount||a.participants_count||0,"/",a.maxParticipants||a.max_participants||"∞",")"]},a.id))]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-2",children:"Cari Peserta"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:f,onChange:a=>K(a.target.value),placeholder:"Cari berdasarkan nama, email, NIK, atau no HP",className:"w-full border p-2 rounded",onKeyDown:a=>a.key==="Enter"&&D()}),e.jsx("button",{onClick:D,className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"Cari"})]})]})]}),R?e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Nama"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Telepon"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"NIK"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Instansi"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"No. Registrasi"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Tanggal Daftar"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Aksi"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:[...Array(8)].map((a,t)=>e.jsxs("tr",{className:"animate-pulse",children:[e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-32"})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-40"})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-24"})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-32"})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-28"})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-20"})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsx("div",{className:"h-4 bg-gray-200 rounded w-24"})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-16"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded w-16"})]})})]},t))})]})})}):e.jsx(e.Fragment,{children:r?N.length>0?e.jsxs(e.Fragment,{children:[g>0&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsxs("strong",{children:["Total: ",g," peserta"]})," | Menampilkan ",(d-1)*x+1," - ",Math.min(d*x,g)," dari ",g," peserta | Halaman ",d," dari ",u]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white border border-gray-300",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"px-4 py-2 border",children:"No Registrasi"}),e.jsx("th",{className:"px-4 py-2 border",children:"Nama"}),e.jsx("th",{className:"px-4 py-2 border",children:"Email"}),e.jsx("th",{className:"px-4 py-2 border",children:"Telepon"}),e.jsx("th",{className:"px-4 py-2 border",children:"NIK"}),e.jsx("th",{className:"px-4 py-2 border",children:"Instansi"}),e.jsx("th",{className:"px-4 py-2 border",children:"Terdaftar"}),e.jsx("th",{className:"px-4 py-2 border",children:"Aksi"})]})}),e.jsx("tbody",{children:N.map(a=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 border font-mono text-xs",children:a.registrationNumber}),e.jsx("td",{className:"px-4 py-2 border",children:a.name}),e.jsx("td",{className:"px-4 py-2 border",children:a.email||"-"}),e.jsx("td",{className:"px-4 py-2 border",children:a.phoneNumber||"-"}),e.jsx("td",{className:"px-4 py-2 border font-mono text-xs",children:G(a.nik)}),e.jsx("td",{className:"px-4 py-2 border",children:a.institution||"-"}),e.jsx("td",{className:"px-4 py-2 border whitespace-nowrap",children:new Date(a.createdAt).toLocaleDateString("id-ID")}),e.jsxs("td",{className:"px-4 py-2 border",children:[e.jsx("button",{onClick:()=>B(a),className:"bg-yellow-500 text-white px-2 py-1 rounded mr-2 hover:bg-yellow-600 text-xs",children:"Edit"}),e.jsx("button",{onClick:()=>H(a.id),className:"bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs",children:"Hapus"})]})]},a.id))})]})}),u>1&&e.jsx("div",{className:"flex justify-center mt-6",children:e.jsxs("div",{className:"flex",children:[e.jsx("button",{onClick:()=>m(a=>Math.max(1,a-1)),disabled:d===1,className:"px-3 py-1 border border-gray-300 rounded-l bg-white disabled:bg-gray-100 disabled:text-gray-400",children:"« Prev"}),Array.from({length:u},(a,t)=>e.jsx("button",{onClick:()=>m(t+1),className:`px-3 py-1 border-t border-b border-gray-300 ${d===t+1?"bg-blue-500 text-white":"bg-white"}`,children:t+1},t+1)),e.jsx("button",{onClick:()=>m(a=>Math.min(u,a+1)),disabled:d===u,className:"px-3 py-1 border border-gray-300 rounded-r bg-white disabled:bg-gray-100 disabled:text-gray-400",children:"Next »"})]})})]}):e.jsx("div",{className:"text-center p-12 bg-gray-50 rounded",children:e.jsx("p",{className:"text-gray-600",children:"Belum ada peserta untuk event ini."})}):e.jsx("div",{className:"text-center p-12 bg-gray-50 rounded",children:e.jsx("p",{className:"text-gray-600",children:"Pilih event untuk melihat daftar peserta."})})}),L&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg w-full max-w-xl",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:j?"Edit Peserta":"Tambah Peserta Baru"}),e.jsxs("form",{onSubmit:z,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2",children:"Nama Lengkap"}),e.jsx("input",{type:"text",value:o.name,onChange:a=>p({...o,name:a.target.value}),className:"w-full border p-2 rounded",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2",children:"Email (Opsional)"}),e.jsx("input",{type:"email",value:o.email,onChange:a=>p({...o,email:a.target.value}),className:"w-full border p-2 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2",children:"Nomor HP"}),e.jsx("input",{type:"tel",value:o.phone_number,onChange:a=>p({...o,phone_number:a.target.value}),className:"w-full border p-2 rounded",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block mb-2",children:"NIK (KTP)"}),e.jsx("input",{type:"text",value:o.nik,onChange:a=>p({...o,nik:a.target.value}),className:"w-full border p-2 rounded",required:!0,pattern:"[0-9]{16}",title:"NIK harus berisi 16 digit angka",placeholder:"16 digit angka NIK"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block mb-2",children:"Instansi/Organisasi (Opsional)"}),e.jsx("input",{type:"text",value:o.institution,onChange:a=>p({...o,institution:a.target.value}),className:"w-full border p-2 rounded"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx("button",{type:"button",onClick:()=>b(!1),className:"bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600",children:"Batal"}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:j?"Simpan Perubahan":"Tambah Peserta"})]})]})]})})]})})};export{ae as ParticipantManagement,ae as default};
