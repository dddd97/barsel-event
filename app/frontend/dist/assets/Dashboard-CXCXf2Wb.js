import{j as e}from"./ui-CmEgarRF.js";import{r as c,L as p}from"./vendor-Ce54acmE.js";import{u as R,i as D}from"./index-BjMOTf-D.js";import E from"./AdminLayout-Bdj-l822.js";import"./auth-B5F6nbqB.js";import"./utils-DH2Y5gFI.js";const L=()=>{const{isAuthenticated:i,isAdmin:r}=R(),[b,f]=c.useState(null),[g,o]=c.useState(!1),[A,j]=c.useState(null),[k,m]=c.useState(null),v=c.useRef(null),t=c.useRef(null),s=c.useRef(null),h=c.useRef(0),S=3,u=c.useRef(!1),_=c.useRef(i&&r);c.useEffect(()=>{const a=i&&r;(()=>{_.current!==a&&(_.current=a,setTimeout(()=>{a&&!g&&!u.current?(console.log("Admin authentication confirmed, attempting connection..."),w()):a||(console.log("Admin authentication lost, disconnecting..."),N())},1e3))})()},[i,r]);const y=c.useCallback(()=>{s.current&&clearInterval(s.current),s.current=setInterval(async()=>{if(!(!i||!r))try{const a=await fetch("/api/dashboard/stats",{credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(a.ok){const x=await a.json();f({timestamp:Date.now()/1e3,eventsCount:x.events?.total||0,participantsCount:x.participants?.total||0,activeEvents:x.events?.active||0,recentRegistrations:(x.recent_registrations||[]).map(d=>({id:d.id||Math.random(),name:d.name||"Unknown",eventName:d.event_name||"Unknown Event",registrationNumber:d.registration_number||"N/A",createdAt:d.created_at||new Date().toISOString()})),recentLogins:[],systemAlerts:[]}),j(new Date),m(null)}}catch(a){(a instanceof TypeError||a?.message?.includes("network"))&&(console.warn("Network error in polling fallback:",a.message),m("Connection unstable - using fallback mode"))}},2e4)},[i,r]),w=c.useCallback(()=>{if(!i||!r){console.warn("Cannot connect to real-time updates: not authenticated as admin"),m("Admin authentication required");return}if(u.current||v.current){console.log("Connection already in progress or exists");return}u.current=!0;try{const a=new EventSource("/api/dashboard/events",{withCredentials:!0}),x=setTimeout(()=>{g||(console.warn("Real-time connection timeout, falling back to polling mode"),a.close(),m(null),u.current=!1,y())},3e4);a.onopen=()=>{console.log("Real-time connection established"),clearTimeout(x),o(!0),m(null),h.current=0,u.current=!1,s.current&&(clearInterval(s.current),s.current=null)},a.onmessage=d=>{try{if(d.data==="connected"){clearTimeout(x),o(!0),m(null),h.current=0,u.current=!1;return}if(JSON.parse(d.data).message==="Connection error"){console.warn("Server sent connection error message - likely authentication issue"),m("Authentication required"),o(!1),u.current=!1,a.close();return}}catch{console.warn("Received non-JSON message:",d.data)}},a.addEventListener("initial",d=>{try{const n=JSON.parse(d.data),C={timestamp:n.timestamp,eventsCount:n.events_count,participantsCount:n.participants_count,activeEvents:n.active_events,recentRegistrations:(n.recent_registrations||[]).map(l=>({id:l.id,name:l.name,eventName:l.event_name,registrationNumber:l.registration_number,createdAt:l.created_at})),recentLogins:(n.recent_logins||[]).map(l=>({adminName:l.admin_name,ipAddress:l.ip_address,createdAt:l.created_at})),systemAlerts:n.system_alerts||[]};f(C),j(new Date)}catch(n){console.error("Error parsing initial data:",n)}}),a.addEventListener("update",d=>{try{const n=JSON.parse(d.data),C={timestamp:n.timestamp,eventsCount:n.events_count,participantsCount:n.participants_count,activeEvents:n.active_events,recentRegistrations:(n.recent_registrations||[]).map(l=>({id:l.id,name:l.name,eventName:l.event_name,registrationNumber:l.registration_number,createdAt:l.created_at})),recentLogins:(n.recent_logins||[]).map(l=>({adminName:l.admin_name,ipAddress:l.ip_address,createdAt:l.created_at})),systemAlerts:n.system_alerts||[]};f(C),j(new Date)}catch(n){console.error("Error parsing update data:",n)}}),a.addEventListener("heartbeat",()=>{}),a.onerror=d=>{if(console.error("EventSource error:",d),o(!1),u.current=!1,a.readyState===EventSource.CLOSED)if(console.log("Connection closed by server"),h.current<S&&i&&r){const n=Math.min(Math.pow(2,h.current)*2e3,3e4);h.current++,console.log(`Attempting to reconnect in ${n}ms (attempt ${h.current})`),m(`Connection lost. Reconnecting in ${n/1e3}s...`),t.current=setTimeout(()=>{i&&r&&w()},n)}else console.warn("Max reconnection attempts reached or not authenticated as admin, switching to polling mode"),m(null),i&&r&&y()},v.current=a}catch(a){console.error("Error creating EventSource:",a),m("Failed to establish real-time connection"),u.current=!1,i&&r&&y()}},[y]),N=c.useCallback(()=>{u.current=!1,v.current&&(v.current.close(),v.current=null),t.current&&(clearTimeout(t.current),t.current=null),s.current&&(clearInterval(s.current),s.current=null),o(!1),m(null),h.current=0},[]);return c.useEffect(()=>{let a=!0,x;return(()=>{a&&i&&r&&!g&&!u.current?x=setTimeout(()=>{a&&i&&r&&!g&&!u.current&&w()},1e3):a&&(!i||!r)&&N()})(),()=>{a=!1,x&&clearTimeout(x)}},[]),c.useEffect(()=>()=>{N()},[N]),{data:b,isConnected:g,lastUpdated:A,error:k,connect:w,disconnect:N}},P=()=>{const{user:i}=R(),{data:r,isConnected:b,lastUpdated:f,error:g}=L(),[o,A]=c.useState(null),[j,k]=c.useState(!0);c.useEffect(()=>{(async()=>{try{const s=await D.get("/api/dashboard/stats");A(s.data)}catch(s){console.error("Error fetching dashboard stats:",s)}finally{k(!1)}})()},[]);const m=t=>{if(!t)return"No date";try{const s=new Date(t);return isNaN(s.getTime())?"Invalid date":s.toLocaleString("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(s){return console.error("Date formatting error:",s),"Invalid date"}},v=t=>{switch(t){case"danger":return"bg-red-100 text-red-800 border-red-200";case"warning":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"info":return"bg-blue-100 text-blue-800 border-blue-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};return j?e.jsx(E,{children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full"}),e.jsxs("div",{children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-32 mb-2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-24"})]})]}),e.jsx("div",{className:"h-8 bg-gray-200 rounded w-28"})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8",children:[...Array(4)].map((t,s)=>e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-20"}),e.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded"})]}),e.jsx("div",{className:"h-8 bg-gray-200 rounded w-16 mb-2"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-24"})]},s))}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 border",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-40 mb-6"}),e.jsx("div",{className:"h-64 bg-gray-200 rounded"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 border",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-36 mb-6"}),e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((t,s)=>e.jsxs("div",{className:"flex items-start space-x-3 p-3",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-200 rounded-full"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4 mb-2"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"})]})]},s))})]})]}),e.jsxs("div",{className:"mt-8 bg-white rounded-lg shadow p-6 border",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-32 mb-6"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[...Array(4)].map((t,s)=>e.jsx("div",{className:"h-24 bg-gray-200 rounded-lg"},s))})]})]})}):e.jsxs(E,{children:[e.jsxs("div",{className:"animate-fade-in-up",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Dashboard"}),e.jsx("div",{className:"mt-2 flex items-center space-x-3",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative w-10 h-10 rounded-full shadow-lg overflow-hidden border-2 border-white",children:[e.jsx("img",{src:i?.avatar?i.avatar.startsWith("http")?i.avatar:`/uploads/avatars/${i.avatar}`:`https://ui-avatars.com/api/?name=${encodeURIComponent(i?.name||"Admin")}&background=3b82f6&color=ffffff&size=128`,alt:i?.name||"Admin",className:"w-full h-full object-cover",onError:t=>{const s=t.currentTarget;s.style.display="none";const h=s.nextElementSibling;h&&(h.style.display="flex")}}),e.jsx("div",{className:"w-full h-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center hidden",children:e.jsx("span",{className:"text-white font-bold text-lg",children:i?.name?.charAt(0)?.toUpperCase()||"A"})})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Selamat datang, ",e.jsx("span",{className:"font-medium text-gray-900",children:i?.name})]}),e.jsxs("p",{className:"text-xs text-gray-500 flex items-center",children:[e.jsx("span",{className:"inline-block w-2 h-2 bg-green-500 rounded-full mr-1"}),i?.role==="super_admin"?"Super Administrator":"Administrator"]})]})]})})]}),e.jsx("div",{className:"flex items-center space-x-3",children:e.jsxs(p,{to:"/admin/profile",className:"flex items-center px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"Edit Profile"]})})]}),e.jsx("div",{className:"mt-4 flex items-center justify-end",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${b?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs text-gray-500",children:b?"Real-time connected":"Disconnected"}),f&&e.jsxs("span",{className:"text-xs text-gray-400",children:["• Last updated: ",f.toLocaleTimeString()]})]})})]}),g&&e.jsx("div",{className:"mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:e.jsx("p",{className:"text-sm text-yellow-800",children:g})})]}),r?.systemAlerts&&r.systemAlerts.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-3",children:"System Alerts"}),e.jsx("div",{className:"space-y-2",children:r.systemAlerts.map((t,s)=>e.jsxs("div",{className:`p-3 border rounded-md ${v(t.type)}`,children:[e.jsx("p",{className:"text-sm font-medium",children:t.message}),t.action==="view_audit_logs"&&!0&&e.jsx(p,{to:"/admin/audit-logs",className:"mt-2 inline-block text-xs underline",children:"View Audit Logs"})]},s))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsx("div",{className:"bg-white overflow-hidden shadow rounded-lg",children:e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})})})}),e.jsx("div",{className:"ml-5 w-0 flex-1",children:e.jsxs("dl",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500 truncate",children:"Events"}),e.jsx("dd",{className:"text-lg font-medium text-gray-900",children:r?r.eventsCount:o?.events.total||0}),e.jsxs("dd",{className:"text-sm text-gray-500",children:[r?r.activeEvents:o?.events.active||0," active"]})]})})]})})}),e.jsx("div",{className:"bg-white overflow-hidden shadow rounded-lg",children:e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-8 h-8 bg-green-500 rounded-md flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"})})})}),e.jsx("div",{className:"ml-5 w-0 flex-1",children:e.jsxs("dl",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500 truncate",children:"Participants"}),e.jsx("dd",{className:"text-lg font-medium text-gray-900",children:r?r.participantsCount:o?.participants.total||0}),e.jsxs("dd",{className:"text-sm text-gray-500",children:[o?.participants.today||0," today"]})]})})]})})}),e.jsx("div",{className:"bg-white overflow-hidden shadow rounded-lg",children:e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})})}),e.jsx("div",{className:"ml-5 w-0 flex-1",children:e.jsxs("dl",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500 truncate",children:"Prizes"}),e.jsx("dd",{className:"text-lg font-medium text-gray-900",children:o?.prizes.total||0}),e.jsxs("dd",{className:"text-sm text-gray-500",children:[o?.prizes.remaining||0," remaining"]})]})})]})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx("div",{className:"bg-white shadow rounded-lg",children:e.jsxs("div",{className:"px-4 py-5 sm:p-6",children:[e.jsx("h3",{className:"text-lg leading-6 font-medium text-gray-900 mb-4",children:"Recent Registrations"}),r?.recentRegistrations&&r.recentRegistrations.length>0?e.jsx("div",{className:"space-y-3",children:r.recentRegistrations.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-md",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:t.name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.eventName}),e.jsxs("p",{className:"text-xs text-gray-400",children:["#",t.registrationNumber]})]}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:"text-xs text-gray-500",children:m(t.createdAt)})})]},t.id))}):e.jsx("p",{className:"text-sm text-gray-500",children:"No recent registrations"})]})}),e.jsx("div",{className:"bg-white shadow rounded-lg",children:e.jsxs("div",{className:"px-4 py-5 sm:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg leading-6 font-medium text-gray-900",children:"Recent Activities"}),e.jsx(p,{to:"/admin/audit-logs",className:"text-sm text-blue-600 hover:text-blue-500",children:"View All"})]}),o?.recentActivities&&o.recentActivities.length>0?e.jsx("div",{className:"space-y-3",children:o.recentActivities.slice(0,5).map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-md",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:t.adminName}),e.jsx("p",{className:"text-xs text-gray-600",children:t.actionDisplayName}),t.resourceDisplayName&&e.jsx("p",{className:"text-xs text-gray-500",children:t.resourceDisplayName})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500",children:m(t.createdAt)}),e.jsx("p",{className:"text-xs text-gray-400",children:t.ipAddress})]})]},t.id))}):e.jsx("p",{className:"text-sm text-gray-500",children:"No recent activities"})]})})]}),e.jsxs("div",{className:"mt-8 bg-white shadow rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Quick Actions"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(p,{to:"/admin/events",className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700",children:"Manage Events"}),e.jsx(p,{to:"/admin/participants",className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700",children:"Manage Participants"}),e.jsx(p,{to:"/admin/prizes",className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700",children:"Manage Prizes"}),e.jsxs(p,{to:"/admin/draw",className:"relative inline-flex items-center justify-center px-6 py-3 border border-transparent text-sm font-bold rounded-xl shadow-lg text-white bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 hover:from-orange-600 hover:via-red-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-300 hover:shadow-2xl overflow-hidden group",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 opacity-0 group-hover:opacity-20 transition-opacity duration-300"}),e.jsxs("div",{className:"absolute inset-0 opacity-30",children:[e.jsx("div",{className:"absolute top-1 left-1 w-1 h-1 bg-white rounded-full animate-ping"}),e.jsx("div",{className:"absolute top-3 right-2 w-1 h-1 bg-white rounded-full animate-ping",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-2 left-3 w-1 h-1 bg-white rounded-full animate-ping",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute bottom-1 right-1 w-1 h-1 bg-white rounded-full animate-ping",style:{animationDelay:"1.5s"}})]}),e.jsx("svg",{className:"w-5 h-5 mr-2 relative z-10",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M5 9V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v2a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4zM3 9a6 6 0 0 0 6 6h2v3h1a1 1 0 0 1 1 1v1h-8v-1a1 1 0 0 1 1-1h1v-3H5a6 6 0 0 1-6-6V8a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1zm18 0V8a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a6 6 0 0 1-6 6h-2v3h1a1 1 0 0 1 1 1v1h-8v-1a1 1 0 0 1 1-1h1v-3h2a6 6 0 0 0 6-6z"})}),e.jsx("span",{className:"relative z-10",children:"🎁 Prize Drawing"}),e.jsx("div",{className:"absolute inset-0 -top-1 -bottom-1 bg-gradient-to-r from-transparent via-white to-transparent opacity-20 transform -skew-x-12 translate-x-full group-hover:-translate-x-full transition-transform duration-1000"})]}),e.jsx(p,{to:"/admin/audit-logs",className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-gray-600 hover:bg-gray-700",children:"View Audit Logs"})]})]})]})};export{P as default};
